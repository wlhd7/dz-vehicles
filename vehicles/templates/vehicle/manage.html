{% extends "base.html" %}

{% block content %}
<h2>车辆管理</h2>

<section>
	<h3>添加车辆</h3>
	<form id="addVehicleForm">
		<input type="text" name="plate" id="plate" placeholder="车牌号" required>
		<button type="submit">添加</button>
	</form>
</section>

<section>
	<h3>现有车辆</h3>
	<table id="vehiclesTable" border="1" cellpadding="6" cellspacing="0">
		<thead>
			<tr>
				<th>ID</th>
				<th>车牌</th>
				<th>状态</th>
				<th>操作</th>
			</tr>
		</thead>
		<tbody>
			{% for v in vehicles %}
			<tr data-id="{{ v['id'] }}">
				<td>{{ v['id'] }}</td>
				<td>{{ v['plate'] }}</td>
				<td>{{ v['status'] }}</td>
				<td><button class="deleteBtn">删除</button></td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</section>

<script>
document.getElementById('addVehicleForm').addEventListener('submit', async function(e){
	e.preventDefault();
	const plate = document.getElementById('plate').value.trim();
	const payload = { plate };

	const res = await fetch('{{ url_for("vehicle.add") }}', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify(payload)
	});

	const data = await res.json();
	if (!res.ok) {
		alert(data.error || '添加失败');
		return;
	}

	// Append new row to table using returned id
	const tbody = document.querySelector('#vehiclesTable tbody');
	const newRow = document.createElement('tr');
	const newId = data.id || '--';
	newRow.setAttribute('data-id', newId);
	newRow.innerHTML = `
		<td>${newId}</td>
		<td>${plate}</td>
		<td></td>
		<td><button class="deleteBtn">删除</button></td>
	`;
	tbody.appendChild(newRow);

	// clear form
	document.getElementById('addVehicleForm').reset();

	// prefer to refresh to get real IDs; but the UI shows the added vehicle immediately
});

// Delegate delete clicks
document.querySelector('#vehiclesTable').addEventListener('click', async function(e){
	if (!e.target.classList.contains('deleteBtn')) return;
	const tr = e.target.closest('tr');
	const id = tr.getAttribute('data-id');
	if (!id) {
		// If no id (just-added row), remove locally
		tr.remove();
		return;
	}

	if (!confirm('确认删除该车辆？')) return;

	const res = await fetch('{{ url_for("vehicle.delete") }}', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ id })
	});

	const data = await res.json();
	if (!res.ok) {
		alert(data.error || '删除失败');
		return;
	}

	tr.remove();
});
</script>

{% endblock %}
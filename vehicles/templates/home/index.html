{% extends "base.html" %}

{% block content %}
    {% if g.user %}
        <h2>欢迎, {{ g.user.username }}!</h2>
        {% if g.user.is_identified == 1 %}
            <p>已通过核实。</p>
            {% if request.args.get('password') %}
                <p>取出密码: {{ request.args.get('password') }}</p>
            {% endif %}
            <form method="post" action="{{ url_for('lock.retrieve') }}">
                <label for="vehicle">车辆</label>
                <select name="vehicle" id="vehicle">
                    <option value="">-- 请选择车辆 --</option>
                    {% for v in vehicles %}
                        <option value="{{ v['plate'] }}">{{ v['plate'] }}</option>
                    {% endfor %}
                </select>

                <label for="gasCard">加油卡</label>
                <select name="gasCard" id="gasCard" onchange="toggleGasCardInput(this)">
                    <option value="">-- 请选择加油卡 --</option>
                        {% for card in gas_cards %}
                            <option value="{{ card['card_number'] }}">{{ card['card_number'] }}</option>
                        {% endfor %}
                    <option value="other">其他（手动输入）</option>
                </select>
                <input type="text" name="gasCard_custom" id="gasCard_custom" placeholder="手动输入加油卡号" style="display:none;margin-left:8px;">

                <button type="submit">获取密码</button>
            </form>

            <script>
                function toggleGasCardInput(sel) {
                    var custom = document.getElementById('gasCard_custom');
                    if (sel.value === 'other') {
                        custom.style.display = 'inline-block';
                    } else {
                        custom.style.display = 'none';
                        custom.value = '';
                    }
                }
            </script>
        {% elif g.user.is_identified == 2 %}
            <p>已提交核实申请，请联系网管通过核实。</p>
            <p>手机号码： 19128704613</p>
            <p>微信： 18665373915</p>
        {% else %}
            {# 0 = none, 3 = rejected -> allow (re)apply #}
            <a href="{{ url_for('auth.identification') }}">认证</a>
            {% if g.user.is_identified == 3 %}
                <p>您的申请被拒绝, 请重新提交。注：用户名必须使用真实姓名。</p>
                <a href="{{ url_for('auth.register') }}">重新注册</a>
            {% endif %}
        {% endif %}

        {% if g.user.username == 'admin' %}
            <a href="{{ url_for('auth.audit') }}">审核</a>
            <a href="{{ url_for('lock.password') }}">密码管理</a>
            <a href="{{ url_for('vehicle.manage') }}">车辆管理</a>
            <a href="{{ url_for('gas_card.manage') }}">加油卡管理</a>
        {% endif %}
    {% else %}
        <a href="{{ url_for('auth.login') }}">登陆</a>
        <a href="{{ url_for('auth.register') }}">注册</a>
    {% endif %}

    
{% endblock %}
{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home/index.css') }}">
{% endblock %}

{% block body_class %}index-page{% endblock %}

{% block content %}
    <a href="{{ url_for('record.vehicle') }}" class="index-link">查看车辆记录</a>
    <a href="{{ url_for('record.gas') }}" class="index-link">查看油卡记录</a>
    {% if g.user %}
        <h2>已登陆</h2>
        {% if g.user.is_identified == 1 %}
            <p>已通过核实。</p>

            <form id="retrieveForm" class="retrieveForm" method="post" action="{{ url_for('lock.submit') }}">
                <label for="vehicle">车辆</label>
                <select name="vehicle" id="vehicle">
                    <option value="">-- 请选择车辆 --</option>
                    {% for v in vehicles %}
                        <option value="{{ v['plate'] }}" data-status="{{ v['status'] }}">{{ v['plate'] }}</option>
                    {% endfor %}
                </select>

                <label for="gasCard">加油卡</label>
                <select name="gasCard" id="gasCard" onchange="toggleGasCardInput(this)">
                    <option value="">-- 请选择加油卡 --</option>
                    {% for card in gas_cards %}
                        <option value="{{ card['card_number'] }}" data-status="{{ card['status'] }}">{{ card['card_number'] }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="gasCard_custom" id="gasCard_custom" placeholder="手动输入加油卡号" style="display:none;margin-left:8px;">

                <div id="returnFields" style="margin-top:8px; display:none;">
                    <label for="balance">加油卡余额</label>
                    <input type="text" name="balance" id="balance" placeholder="填写余额">
                </div>

                <button type="submit">获取密码</button>

                <div style="margin-top:12px;">
                    <strong>可用车辆：</strong>
                    {% set vehicle_available = vehicles|selectattr('status','equalto','returned')|list %}
                    {% if vehicle_available %}
                        <span>{{ vehicle_available|length }} 辆可用：</span>
                        {% for v in vehicle_available %}
                            <code style="margin-right:6px;">{{ v['plate'] }}</code>
                        {% endfor %}
                    {% else %}
                        <span>暂无可用车辆。</span>
                    {% endif %}
                </div>

                <div style="margin-top:8px;">
                    <strong>可用加油卡：</strong>
                    {% set available = gas_cards|selectattr('status','equalto','returned')|list %}
                    {% if available %}
                        <span>{{ available|length }} 张可用：</span>
                        {% for c in available %}
                            <code style="margin-right:6px;">{{ c['card_number'] }}</code>
                        {% endfor %}
                    {% else %}
                        <span>暂无可用加油卡。</span>
                    {% endif %}
                </div>
            </form>

            <p id="selectionNote" style="color: #555; margin-top:8px;"></p>

            {% if request.args.get('password') %}
                <p>临时密码: {{ request.args.get('password') }}</p>
            {% elif request.args.get('no_password') %}
                <p style="color:#b00;">没有可用的临时密码，请联系管理员添加。</p>
            {% endif %}

            <div id="retrieveError" role="alert" style="color: #b00; margin-top:8px;"></div>

            <script>
                var retrieveForm = document.getElementById('retrieveForm');
                var retrieveError = document.getElementById('retrieveError');

                function toggleGasCardInput(sel) {
                    var custom = document.getElementById('gasCard_custom');
                    var returnFields = document.getElementById('returnFields');
                    if (!custom || !returnFields) return;
                    if (sel.value === 'other') {
                        custom.style.display = 'inline-block';
                    } else {
                        custom.style.display = 'none';
                        custom.value = '';
                    }

                    // Show balance input when the selected gas card is currently taken
                    var opt = sel.options[sel.selectedIndex];
                    var status = opt ? opt.getAttribute('data-status') : '';
                    if (status === 'taken') {
                        returnFields.style.display = 'block';
                    } else {
                        returnFields.style.display = 'none';
                        var bal = document.getElementById('balance');
                        if (bal) bal.value = '';
                    }
                }

                // initialize visibility on load
                (function(){
                    var gasSel = document.getElementById('gasCard');
                    if (gasSel) toggleGasCardInput(gasSel);
                })();

                retrieveForm.addEventListener('submit', function(e){
                    retrieveError.textContent = '';
                    var vehicle = (document.getElementById('vehicle').value || '').trim();
                    var gasCard = (document.getElementById('gasCard').value || '').trim();
                    var gasCardCustom = (document.getElementById('gasCard_custom').value || '').trim();
                    var balance = (document.getElementById('balance').value || '').trim();

                    if (gasCard === 'other' && !gasCardCustom) {
                        e.preventDefault();
                        retrieveError.textContent = '请选择加油卡。';
                        document.getElementById('gasCard_custom').focus();
                        return false;
                    }

                    if (!vehicle && !gasCard && !gasCardCustom) {
                        e.preventDefault();
                        retrieveError.textContent = '必须选择车辆或加油卡之一才能提交。';
                        document.getElementById('vehicle').focus();
                        return false;
                    }

                    // If selected gas card is taken, require balance
                    var gasSel = document.getElementById('gasCard');
                    var gasStatus = '';
                    if (gasSel && gasSel.selectedIndex >= 0) {
                        var opt = gasSel.options[gasSel.selectedIndex];
                        gasStatus = opt ? (opt.getAttribute('data-status') || '') : '';
                    }
                    if (gasStatus === 'taken' && !balance) {
                        e.preventDefault();
                        retrieveError.textContent = '归还加油卡请填写余额。';
                        document.getElementById('balance').focus();
                        return false;
                    }
                });
            </script>
        {% elif g.user.is_identified == 2 %}
            <p>已提交核实申请，请联系网管通过核实。</p>
            <p>手机号码： 19128704613</p>
            <p>微信： 18665373915</p>
        {% else %}
            {# 0 = none, 3 = rejected -> allow (re)apply #}
            <a href="{{ url_for('auth.identification') }}">初次登陆, 请点击此处进入审核页面。</a>
            {% if g.user.is_identified == 3 %}
                <p>您的申请被拒绝, 请重新提交。注：用户名必须使用真实姓名。</p>
                <a href="{{ url_for('auth.register') }}">重新注册</a>
            {% endif %}
        {% endif %}

        {% if g.user.username == 'admin' %}
            <a href="{{ url_for('auth.audit') }}">审核</a>
            <a href="{{ url_for('lock.password') }}">密码管理</a>
            <a href="{{ url_for('vehicle.manage') }}">车辆管理</a>
            <a href="{{ url_for('gas_card.manage') }}">加油卡管理</a>
        {% endif %}
    {% else %}
        <a href="{{ url_for('auth.login') }}" class="index-link">登陆</a>
        <a href="{{ url_for('auth.register') }}" class="index-link">注册</a>
    {% endif %}

    
{% endblock %}
